name: Accessibility (pa11y-ci)

on:
  pull_request:
  push:
    branches: [main]

permissions:
  contents: read

jobs:
  pa11y:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      # Run pa11y-ci, but NEVER fail the workflow on this step.
      # Capture exit code so we can write a warning in the Summary.
      - name: Run pa11y-ci (soft fail)
        id: pa11y
        run: |
          mkdir -p pa11y
          echo "placeholder" > pa11y/_placeholder.txt

          set +e
          npm run test:a11y
          echo "exit_code=$?" >> "$GITHUB_OUTPUT"
          set -e

          # Always succeed so next steps run and workflow stays green
          exit 0

      - name: Upload pa11y artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pa11y-report
          path: pa11y/
          if-no-files-found: warn

      - name: Write GitHub Actions Summary
        if: always()
        run: |
          code="${{ steps.pa11y.outputs.exit_code }}"

          echo "## ♿️ Pa11y CI results" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "$code" != "0" ]; then
            echo "⚠️ Pa11y reported accessibility issues (exit code: **$code**)." >> "$GITHUB_STEP_SUMMARY"
            echo "" >> "$GITHUB_STEP_SUMMARY"
            echo "Download the **pa11y-report** artifact to view the HTML/JSON report." >> "$GITHUB_STEP_SUMMARY"
          else
            echo "✅ No accessibility issues detected." >> "$GITHUB_STEP_SUMMARY"
          fi
